<p><!DOCTYPE html>
<html>
<title>Redes de Computadores 2 - Prof. Ricardo da Rocha</title></p>

<p><xmp theme="simplex" style="display:none;"></p>

<h1>Laboratório 04: Controle de Congestionamento no TCP</h1>

<h1>Objetivos</h1>

<ul>
<li>Entender as causas e feitos de um congestionamento para o TCP</li>
<li>Entender o efeito do controle de congestionamento no TCP</li>
<li>Aprofundar o uso do mininet, wireshark e a configuração de um ambiente com uso de programas em python</li>
</ul>

<h1>Visão Geral</h1>

<p>Neste laboratório iremos verificar o funcionamento do controle de congestionamento do TCP usando um ambiente emulado mininet. Este laboratório é baseado em <a href="http://computing.unn.ac.uk/staff/CGDK2/Teaching/EN746/lab10.html">um laboratório</a> da Northumbria University.</p>

<h1>Recursos</h1>

<ul>
<li>Slides: <a href="pdf/controle-congestionamento-tcp.pdf">Controle de Congestionamento no TCP</a></li>
<li>Máquina Virtual com <code>mininet</code></li>
</ul>

<h1>Opções do iperf/mininet úteis para o experimento</h1>

<ul>
<li>iperf
<ul>
<li><code>-c</code>: executa o iperf como cliente</li>
<li><code>-s</code>: executa o iperf como servidor</li>
<li><code>-t 60</code>: estende as medições do iperf por 60 segundos.</li>
<li><code>-b 10M</code>: indica ao iperf que os pacotes devem ser transmitidos à vazão de 10Mbps (<code>1K</code> é 1 Kbps e o default é 1Mpbs) - <strong>apenas para teste UDP</strong></li>
</ul></li>
<li>Mininet (configuração de topologia)
<ul>
<li><code>sudo mn --topo linear,4 --link tc,bw=10,delay=5ms</code>: cria uma topologia de 4 estações, com enlaces de 10Mbps e atraso de 5ms.</li>
</ul></li>
</ul>

<h1>Descrição</h1>

<h3>Congestionamento nos enlaces</h3>

<ol>
<li><p>Crie um cenário no mininet com as seguintes configurações:</p>

<ul>
<li>Quatro estações (H1 a H4)</li>
<li>Enlaces de 10 Mbps</li>
<li>Atrasos de 5ms</li>
<li>Deve haver um enlace compartilhado na comunicação entre H1/H2 e H3/H4.</li>
</ul></li>
<li><p>Utilize o iperf para testar a largura de banda entre as estações na seguinte configuração:</p>

<ul>
<li>Teste a largura de banda entre <strong>H4-H2</strong> e <strong>H3-H1</strong>, considerando
<ul>
<li>H1 e H2 como servidores iperf</li>
<li>H3 e H4 como clientes iperf</li>
<li>Execução dos testes por 60 segundos.</li>
</ul></li>
<li>Teste a largura de banda TCP nos seguintes cenários:
<ol>
<li>Conversa isolada entre os pares de estações (inicie um teste depois de terminar o outro)</li>
<li>Testes simultâneos. </li>
<li>Testes simultâneos <strong>usando UDP</strong> em um dos pares, transmitindo com largura de banda 5Mbps e 10Mbps.</li>
</ol></li>
</ul></li>
</ol>

<!--
* use o iperf para

Quatro estações (h1 a h4)
Enlaces de 10 Mbps
Atrasos de 5ms

* H1 e H2 como servidores iperf
* H3 e H4 como clientes iperf

* Uso o iperf para testar a velocidade TCP entre os enlaces seguintes pares de enlaces:

h4->h2
h3->h1

- teste isoladamente 
- teste simultaneamente

Topologia: single
sudo mn --topo single,4 --link tc,bw=10,delay=5ms

Problema não ocorre


Topologia: linear
Enlaces: 10Mbps
Atraso: 5ms


sudo mn --topo linear,4 --link tc,bw=10,delay=5ms

---
abrir terminais para as 4 estações:
xterm h1 h2 h3 h4

h1: servidor iperf
h2: servidor iperf
h3: cliente
h4: cliente

h4->h2
h3->h1

enlace comum: H2--H3

teste TCP (largura de banda)
iperf -c 10.0.0.1 -t 60

teste UDP (5m e 10m)??
iperf -u -c 10.0.0.2 -t 60 -b 10m

1: testes isolados com TCP
2: testes simultâneos com TCP
3: testes TCP vs. UDP (largura banda UDP em excesso)
-->

<h3>Algoritmo de Controle de Congestionamento do TCP</h3>

<p>Softwares utilizados neste experimento</p>

<ul>
<li>Módulo <code>tcp_probe</code> do Kernel do Linux - estará presente na VM com mininet
<ul>
<li>Permite coletar os valores de parâmetros do TCP - particularmente, janela de congestionamento - durante um experimento.</li>
<li>Documentação:
<ul>
<li><a href="https://wiki.linuxfoundation.org/networking/tcpprobe">https://wiki.linuxfoundation.org/networking/tcpprobe</a></li>
<li><a href="https://wiki.linuxfoundation.org/networking/tcp_testing">https://wiki.linuxfoundation.org/networking/tcp_testing</a> (descrição dos dados coletados)</li>
</ul></li>
</ul></li>
<li><strong>gnuplot</strong>: programa de geração de gráficos
<ul>
<li>Utilizaremos para gerar os gráficos de controle de congestionamento a partir dos resultados gerados pelo <code>tcp_probe</code>.</li>
</ul></li>
</ul>

<p>Para realizar este experimento, siga os seguintes passos:</p>

<ol>
<li><p>Verifique o algoritmo de controle de congestionamento usado pelo Linux</p>

<pre><code>sysctl net.ipv4.tcp_congestion_control
</code></pre></li>
<li><p>Configure o TCP para uso do algoritmo de congestionamento <strong>Reno</strong> (comando abaixo)</p>

<pre><code>sudo sysctl -w net.ipv4.tcp_congestion_control=reno
</code></pre></li>
<li><p>Utilize o cenário de testes anterior (com H1 até H4). A conversa H2-H4 deve ser via UDP com largura de banda 5Mbps. No experimento, testaremos o funcionamento do controle de congestionamento na <strong>estação H3</strong>.</p>

<pre><code>                h2-h4
        h1-h3   h1-h3   h1-h3
tempo 0s-----30s-----60s-----90s
       10Mbps   5Mbps  10Mbps
</code></pre></li>
<li><p>No terminal da estação H3, e <strong>antes da execução do iperf</strong>, carregue o módulo <code>tcp_probe</code> no Linux, indicando para registrar as informações referentes à conexão na porta 5001 (usada pelo iperf) com o seguinte comando:</p>

<pre><code>sudo modprobe tcp_probe port=5001 full=1
</code></pre></li>
<li><p><strong>Realize esses passos com atenção!</strong> Abra um novo terminal na estação hospedeira do mininet (mas fora do sistema mininet) e inicie a coleta dos dados de controle de congestionamento, copiando os dados gerados em <code>/proc/net/tcpprobe</code> (pelo módulo do kernel) no arquivo <code>tcpprobe.out</code>, com o comando abaixo. <strong>Importante</strong>: esse comando ficará executando durante todo o experimento e você deverá finalizá-lo (Ctrl-C), assim que o experimento terminar.</p>

<pre><code>sudo cat /proc/net/tcpprobe &gt; tcpprobe.out
</code></pre></li>
<li><p>Execute o experimento mininet.</p></li>
<li><p>Finalize o comando do passo <strong>(5)</strong>. Se tudo estiver correto, o arquivo <code>tcpprobe.out</code> deverá ter alguns Mbytes. Confira se tudo funcionou antes de continuar. </p>

<ul>
<li>O arquivo <code>tcpprobe.out</code> deverá ter uma saída que deve ser interpretada da seguinte maneira (<a href="https://wiki.linuxfoundation.org/networking/tcp_testing">fonte</a>)
<img src="images/estrutura-saida-tcpprobe.png" /></li>
</ul></li>
<li><p>Gere os gráficos do controle de congestionamento executando o seguinte script gnuplot (observe que o script nas linhas 5 e 6 espera que a fonte dos dados estejam no arquivo <code>tcpprobe.out</code>). Este script pode ser baixado no arquivo <a href="codigo/grafico-congestionamento.gnuplot">grafico-congestionamento.gnuplot</a></p>

<pre><code>set style line 1
show timestamp
set xlabel "Tempo (segundos)"
set ylabel "Segmentos (cwnd, ssthresh)"
plot "tcpprobe.out" using 1:7 title "snd_cwnd - janela", \
     "tcpprobe.out" using 1:($8&gt;=2147483647 ? 0 : $8) title "snd_ssthresh - threshold"
</code></pre></li>
<li><p>Ao final do experimento, remova o módulo <code>tcp_probe</code> com o seguinte comando:</p>

<pre><code>sudo modprobe -r tcp_probe
</code></pre></li>
</ol>

<h2>Referências adicionais</h2>

<ul>
<li>Exemplo e saída do <code>tcpprobe</code>: <a href="https://witestlab.poly.edu/blog/tcp-congestion-control-basics/">https://witestlab.poly.edu/blog/tcp-congestion-control-basics/</a></li>
<li>Algoritmos de controle de congestionamento: <a href="https://en.wikipedia.org/wiki/TCP_congestion_control#Algorithms">https://en.wikipedia.org/wiki/TCP_congestion_control#Algorithms</a></li>
</ul>

<!--
sudo modprobe tcp_probe port=80 full=1
sudo cat /proc/net/tcpprobe > tcpprobe.out


script de geracao de grafico gnuplot
        # set style data linespoints
        set style line 1
        show timestamp
        set xlabel "time (seconds)"
        set ylabel "Segments (cwnd, ssthresh)"
        plot "tcpprobe.out" using 1:7 title "snd_cwnd", \
             "tcpprobe.out" using 1:($8>=2147483647 ? 0 : $8) title "snd_ssthresh"


-->

<p></xmp></p>

<script src="https://strapdownjs.com/v/0.2/strapdown.js"></script>

<p></html></p>
